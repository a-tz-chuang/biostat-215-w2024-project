---
title: "Biostat M215 Final Project"
author: "Rina Arputhasamy, Andrew Chuang, Carolyn Winskill, Kyle Wu"
date: "2024-03-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Biostatistics M215: Final Project

## Libraries: 

```{r}
#Relevant libraries:
library(survival)
library(PAmeasures)
library(tidyverse)
library(kableExtra)
library(pec)
library(MASS)
data_directory <- "functions/"
source(paste0(data_directory, "pam.survreg.update.R"))
```

## Data Preparation

```{r data_load}
data(cancer, package = "survival")
n <- nrow(rotterdam)
```

```{r train_test_split}
# train-test split
test_p <- 0.15
test_indx <- sample(n, n * test_p)
rotterdam_test <- rotterdam[test_indx,]
rotterdam_train <- rotterdam[!seq_len(n) %in% test_indx,]
```

## Full Models and Prediction Accuracy Measures (Rotterdam)

### Cox PH and PAM: 

```{r}
# Fit a multiple Cox PH model with age and edema
fit.coxph <- coxph(Surv(dtime, death) ~ age + meno + size + grade + nodes + pgr + er + hormon + chemo, 
                   data = rotterdam_train, x=TRUE,y=TRUE)
summary(fit.coxph)
# R.squared and L.squared of Cox PH model
pam.coxph(fit.coxph)
concordance(fit.coxph, timewt = "n/G2")$concordance
```

### Exponential AFT Model: 

```{r}
fit.exp <- survreg(Surv(dtime, death) ~ age + meno + size + 
                     grade + nodes + pgr + er + hormon + chemo,
                   data = rotterdam_train, dist="exponential",
                   x = TRUE, y = TRUE)
summary(fit.exp)
# R.squared and L.squared of exponential model
# when data has factors (size), need to pass data directly as shown below
pam.survreg(fit.exp, x.mat = rotterdam_train)
concordance(fit.exp, timewt = "n/G2")$concordance
```

### Lognormal AFT Model: 

```{r}
fit.lognormal <- survreg(Surv(dtime, death) ~ age + meno + size + 
                           grade + nodes + pgr + er + hormon + chemo, 
                   data = rotterdam_train, dist="lognormal",
                   x = TRUE, y = TRUE)
summary(fit.lognormal)
# R.squared and L.squared of the lognormal model
pam.survreg(fit.lognormal, x.mat = rotterdam_train)
concordance(fit.lognormal, timewt = "n/G2")$concordance
```

## Model Selection

We first consider variable selection under the Cox proportional hazards model.

Stepwise forward selection via AIC:
```{r AIC_selection}
full_model_formula <- Surv(dtime, death) ~ age + meno + size + 
                           grade + nodes + pgr + er + hormon + chemo
null_model_formula <- Surv(dtime, death) ~ 1
rot_sfAIC <- stepAIC(coxph(null_model_formula, data = rotterdam_train,
                            x = TRUE, y = TRUE),
                     full_model_formula,
                     direction = "forward", k = 2)
summary(rot_sfAIC)
pam.coxph(rot_sfAIC)
concordance(rot_sfAIC, timewt = "n/G2")$concordance
```

Stepwise backward selection via AIC:
```{r AIC_selection}
rot_sbAIC <- stepAIC(coxph(full_model_formula,
                             data = rotterdam_train,
                             x = TRUE, y = TRUE),
                     full_model_formula,
                     direction = "backward", k = 2)

summary(rot_sbAIC)
pam.coxph(rot_sbAIC)
concordance(rot_sbAIC, timewt = "n/G2")$concordance
```

Forward and backward selection via AIC result in the same model.

Stepwise forward selection via BIC:
```{r BIC_forward_selection}
rot_sfBIC <- stepAIC(coxph(null_model_formula, data = rotterdam_train,
                           x = TRUE, y = TRUE),
                     full_model_formula,
                     direction = "forward", k = log(n))
summary(rot_sfBIC)
pam.coxph(rot_sfBIC)
concordance(rot_sfBIC, timewt = "n/G2")$concordance
```

Stepwise backward selection via BIC:
```{r BIC_backward_selection}
rot_sbBIC <- stepAIC(coxph(full_model_formula,
                           data = rotterdam_train,
                           x = TRUE, y = TRUE),
                     full_model_formula,
                     direction = "backward", k = log(n))
summary(rot_sbBIC)
pam.coxph(rot_sbBIC)
concordance(rot_sbBIC, timewt = "n/G2")$concordance
```

## Prediction Accuracy Measures (SMART Study Data)

```{r}
data(smarto)
```

### Cox PH and PAM: 
```{r}
# Fit a multiple Cox PH model with age and edema
fit.coxph.smart <- coxph(Surv(TEVENT, EVENT) ~ ., 
                   data = smarto, x=TRUE,y=TRUE)
summary(fit.coxph.smart)
# R.squared and L.squared of Cox PH model
pam.coxph(fit.coxph.smart)
```

### Exponential AFT Model (SMART):
```{r}
fit.exp.smarto <- survreg(Surv(TEVENT, EVENT) ~ ., 
                   data = smarto, dist="exponential", x=TRUE, y=TRUE)
summary(fit.exp.smarto)
# R.squared and L.squared of exponential model
pam.survreg(fit.exp.smarto)
```

### Lognormal AFT Model (SMART):
```{r}
fit.lognormal.smarto <- survreg(Surv(TEVENT, EVENT) ~ ., 
                   data = smarto, dist="lognormal", x=TRUE, y=TRUE)
summary(fit.lognormal.smarto)
# R.squared and L.squared of lognormal model
pam.survreg(fit.lognormal.smarto)
```
### Calibration Plot for Cox PH (SMART Data):

```{r}
t <- rotterdam$dtime %>% mean

calPlot(fit.coxph, time=t, data=rotterdam, method = "quantile", q=5,
        bars=TRUE, type="survival", pseudo=FALSE)
```

